nextflow_process {

    name "Test Process BUILD_VEP_CACHE"
    script "../main.nf"
    process "BUILD_VEP_CACHE"
    tag "modules"
    tag "modules_local"
    tag "build_vep_cache"

    setup {
        run("VEP_GNOMAD_DOWNLOAD") {
            script "../../download/vep_gnomad_download/main.nf"
            process {
                """
                input[0] = 'GRCh38'
                input[1] = 110
                """
            }
        }
        run("WGET_DOWNLOAD") {
            script "../../download/wget_download/main.nf"
            options "-stub"
            process {
                """
                input[0] = Channel.of([
                    'vep_cache_and_plugins',
                    "https://raw.githubusercontent.com/nf-core/test-datasets/raredisease/reference/vep_cache_and_plugins.tar.gz",
                ])
                """
            }
        }
    } 

    
    test("Should run without failures") {

        when {
            options "-stub VEP_GNOMAD_DOWNLOAD"
            process {
                """
                input[0] = WGET_DOWNLOAD.out.downloaded_file.collect()
                input[1] = VEP_GNOMAD_DOWNLOAD.out.gnomad_vcf_tbi.flatten().collect()
                """
            }
        }

        then {
            assert process.success
            assert snapshot(process.out).match()
        }

    }

}
