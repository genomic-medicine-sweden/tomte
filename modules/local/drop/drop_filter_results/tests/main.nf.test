nextflow_process {

    name "Test Process DROP_FILTER_RESULTS"
    script "../main.nf"
    process "DROP_FILTER_RESULTS"
    config "./nextflow.config"
    tag "modules"
    tag "modules_local"
    tag "drop"
    tag "drop_filter_results"

    setup {
        run("GUNZIP", alias: "GUNZIP_FASTA") {
            script "../../../../../modules/nf-core/gunzip/main.nf"
            process {
                """
                input[0] = Channel.of([
                    [ id:'fasta' ],
                    file("${projectDir}/test_data/grch37_chr21.fa.gz", checkIfExists: true)
                ])
                """
            }
        }

        run("SAMTOOLS_FAIDX") {
            script "../../../../../modules/nf-core/samtools/faidx/main.nf"
            process {
                """
                input[0] = GUNZIP_FASTA.out.gunzip
                input[1] = [[],[]]
                input[2] = []
                """
            }
        }

        run("GUNZIP", alias: "GUNZIP_GTF") {
            script "../../../../../modules/nf-core/gunzip/main.nf"
            process {
                """
                input[0] = Channel.of([
                    [ id:'gtf' ],
                    file("${projectDir}/test_data/grch37_chr21.gtf.gz", checkIfExists: true)
                ])
                """
            }
        }

        run("GATK4_CREATESEQUENCEDICTIONARY", alias: "BUILD_DICT") {
            script "../../../../../modules/nf-core/gatk4/createsequencedictionary/main.nf"
            process {
                """
                input[0] = GUNZIP_FASTA.out.gunzip
                """
                }
        }

        run("DROP_SAMPLE_ANNOT") {
            script "../../../../../modules/local/drop/drop_sample_annot/main.nf"
            process {
                """
                input[0] = Channel.of([
                            ['ACC5963A1'], [false], ['reverse'], ['NA'], ["${projectDir}/test_data/test_ACC5963A1.vcf.gz"], ["${projectDir}/test_data/test_ACC5963A1.vcf.gz.tbi"],  ['ACC5963A1'],
                            file("${projectDir}/test_data/ACC5963A1.bam", checkIfExists: true),
                            file("${projectDir}/test_data/ACC5963A1.bam.bai", checkIfExists: true)
                        ])
                input[1] = channel.fromPath("${projectDir}/test_data/drop_data/geneCounts.tsv.gz", checkIfExists: true)
                input[2] = channel.fromPath("${projectDir}/test_data/drop_data/sampleAnnotation.tsv", checkIfExists: true)
                input[3] = 'outrider'
                input[4] = 'fraser'
                """
            }
        }

    }

    test("With AS, AE, and MAE") {
        setup {
            run("DROP_CONFIG_RUN_AS") {
                script "../../../../../modules/local/drop/drop_config_runAS/main.nf"
                process {
                    """
                    input[0] = GUNZIP_FASTA.out.gunzip.join(SAMTOOLS_FAIDX.out.fai).collect()
                    input[1] = GUNZIP_GTF.out.gunzip.collect()
                    input[2] = DROP_SAMPLE_ANNOT.out.drop_annot
                    input[3] = Channel.of([
                        file("${projectDir}/test_data/ACC5963A1.bam", checkIfExists: true),
                        file("${projectDir}/test_data/ACC5963A1.bam.bai", checkIfExists: true)
                        ])
                    input[4] = channel.fromPath("${projectDir}/test_data/drop_data/geneCounts.tsv.gz", checkIfExists: true)
                    input[5] = channel.fromPath("${projectDir}/test_data/drop_data", checkIfExists: true)
                    input[6] = 'GRCh37'
                    input[7] = 'fraser'
                    input[8] = 'outrider'
                    input[9] = 1
                    input[10] = true
                    """
                }
            }

            run("DROP_CONFIG_RUN_AE") {
                script "../../../../../modules/local/drop/drop_config_runAE/main.nf"
                process {
                    """
                    input[0] = GUNZIP_FASTA.out.gunzip.join(SAMTOOLS_FAIDX.out.fai).collect()
                    input[1] = GUNZIP_GTF.out.gunzip.collect()
                    input[2] = DROP_SAMPLE_ANNOT.out.drop_annot
                    input[3] = Channel.of([
                            file("${projectDir}/test_data/ACC5963A1.bam", checkIfExists: true),
                            file("${projectDir}/test_data/ACC5963A1.bam.bai", checkIfExists: true)
                        ])
                    input[4] = channel.fromPath("${projectDir}/test_data/drop_data/geneCounts.tsv.gz", checkIfExists: true)
                    input[5] = channel.fromPath("${projectDir}/test_data/drop_data", checkIfExists: true)
                    input[6] = 'GRCh37'
                    input[7] = 'outrider'
                    input[8] = 'fraser'
                    input[9] = 1
                    input[10] = 2.5
                    input[11] = true
                    """
                }
            }

            run("DROP_CONFIG_RUN_MAE") {
                script "../../../../../modules/local/drop/drop_config_runMAE/main.nf"
                process {
                    """
                    input[0] = GUNZIP_FASTA.out.gunzip.join(SAMTOOLS_FAIDX.out.fai).collect()
                    input[1] = GUNZIP_GTF.out.gunzip.collect()
                    input[2] = BUILD_DICT.out.dict.collect()
                    input[3] = DROP_SAMPLE_ANNOT.out.drop_annot
                    input[4] = 'GRCh37'
                    input[5] = Channel.of([
                            file("${projectDir}/test_data/ACC5963A1.bam", checkIfExists: true),
                            file("${projectDir}/test_data/ACC5963A1.bam.bai", checkIfExists: true)
                        ])
                    input[6] = Channel.of([
                            file("${projectDir}/test_data/test_ACC5963A1.vcf.gz", checkIfExists: true),
                            file("${projectDir}/test_data/test_ACC5963A1.vcf.gz.tbi", checkIfExists: true)
                        ])
                    input[7] = Channel.of([
                            file("${projectDir}/test_data/qc_vcf_1000G_hg19_chr21.vcf.gz", checkIfExists: true),
                            file("${projectDir}/test_data/qc_vcf_1000G_hg19_chr21.vcf.gz.tbi", checkIfExists: true)
                        ])
                    """
                }
            }
        }

        when {
            process {
                """
                input[0] = Channel.of([probands:['ACC5963A1'], id:'finequagga']).collect()
                input[1] = channel.fromPath("${projectDir}/test_data/drop_data/mock_gene_panel.tsv", checkIfExists: true).collect()
                input[2] = DROP_CONFIG_RUN_AE.out.drop_ae_rds
                input[3] = DROP_CONFIG_RUN_AS.out.drop_gene_name
                input[4] = DROP_CONFIG_RUN_AS.out.drop_as_tsv
                input[5] = DROP_CONFIG_RUN_MAE.out.drop_mae_tsv
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(
                    process.out.as_out_clinical.collect{ file(it).name },
                    process.out.as_out_research.collect{ file(it).name },
                    process.out.ae_out_clinical.collect{ file(it).name },
                    process.out.ae_out_research.collect{ file(it).name },
                    process.out.mae_out_clinical.collect{ file(it).name },
                    process.out.mae_out_research.collect{ file(it).name },
                    process.out.versions,
                ).match()}
            )
        }

    }

    test("With only AE") {
        setup {
            run("DROP_CONFIG_RUN_AE") {
                script "../../../../../modules/local/drop/drop_config_runAE/main.nf"
                process {
                    """
                    input[0] = GUNZIP_FASTA.out.gunzip.join(SAMTOOLS_FAIDX.out.fai).collect()
                    input[1] = GUNZIP_GTF.out.gunzip.collect()
                    input[2] = DROP_SAMPLE_ANNOT.out.drop_annot
                    input[3] = Channel.of([
                            file("${projectDir}/test_data/ACC5963A1.bam", checkIfExists: true),
                            file("${projectDir}/test_data/ACC5963A1.bam.bai", checkIfExists: true)
                        ])
                    input[4] = channel.fromPath("${projectDir}/test_data/drop_data/geneCounts.tsv.gz", checkIfExists: true)
                    input[5] = channel.fromPath("${projectDir}/test_data/drop_data", checkIfExists: true)
                    input[6] = 'GRCh37'
                    input[7] = 'outrider'
                    input[8] = 'fraser'
                    input[9] = 1
                    input[10] = 2.5
                    input[11] = true
                    """
                }
            }
        }

        when {
            process {
                """
                input[0] = Channel.of([probands:['ACC5963A1'], id:'finequagga']).collect()
                input[1] = channel.fromPath("${projectDir}/test_data/drop_data/mock_gene_panel.tsv", checkIfExists: true).collect()
                input[2] = DROP_CONFIG_RUN_AE.out.drop_ae_rds
                input[3] = DROP_CONFIG_RUN_AE.out.drop_gene_name
                input[4] = []
                input[5] = []
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(
                    process.out.ae_out_clinical.collect{ file(it).name },
                    process.out.ae_out_research.collect{ file(it).name },
                    process.out.versions,
                ).match()}
            )
        }

    }

    test("With only MAE") {
        setup {
            run("DROP_CONFIG_RUN_MAE") {
                script "../../../../../modules/local/drop/drop_config_runMAE/main.nf"
                process {
                    """
                    input[0] = GUNZIP_FASTA.out.gunzip.join(SAMTOOLS_FAIDX.out.fai).collect()
                    input[1] = GUNZIP_GTF.out.gunzip.collect()
                    input[2] = BUILD_DICT.out.dict.collect()
                    input[3] = DROP_SAMPLE_ANNOT.out.drop_annot
                    input[4] = 'GRCh37'
                    input[5] = Channel.of([
                            file("${projectDir}/test_data/ACC5963A1.bam", checkIfExists: true),
                            file("${projectDir}/test_data/ACC5963A1.bam.bai", checkIfExists: true)
                        ])
                    input[6] = Channel.of([
                            file("${projectDir}/test_data/test_ACC5963A1.vcf.gz", checkIfExists: true),
                            file("${projectDir}/test_data/test_ACC5963A1.vcf.gz.tbi", checkIfExists: true)
                        ])
                    input[7] = Channel.of([
                            file("${projectDir}/test_data/qc_vcf_1000G_hg19_chr21.vcf.gz", checkIfExists: true),
                            file("${projectDir}/test_data/qc_vcf_1000G_hg19_chr21.vcf.gz.tbi", checkIfExists: true)
                        ])
                    """
                }
            }
        }

        when {
            process {
                """
                input[0] = Channel.of([probands:['ACC5963A1'], id:'finequagga']).collect()
                input[1] = channel.fromPath("${projectDir}/test_data/drop_data/mock_gene_panel.tsv", checkIfExists: true).collect()
                input[2] = []
                input[3] = DROP_CONFIG_RUN_MAE.out.drop_gene_name
                input[4] = []
                input[5] = DROP_CONFIG_RUN_MAE.out.drop_mae_tsv
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(
                    process.out.mae_out_clinical.collect{ file(it).name },
                    process.out.mae_out_research.collect{ file(it).name },
                    process.out.versions,
                ).match()}
            )
        }

    }

}
